Relay an AWS DeepLens Project Output through AWS SMS
In this section, you take the "Hotdog recognition" sample project and add some rule-based functionality to it to make AWS DeepLens send an SMS notification whenever it detects a hot dog. Though we use the "Hotdog recognition" sample project in this topic, this process could be used for any project, sample or custom.
This section demonstrates how to extend your AWS DeepLens projects to interact with other AWS services. For example, you could extend AWS DeepLens to create:
 A dashboard and search interface for all objects and faces detected by AWS DeepLens with timelines and frames using Amazon Elasticsearch Service.
 Anomaly detection models to detect the number of people walking in front of your store using Kinesis Data Analytics.
 A face detection and celebrity recognition application to identity VIPs around you using Amazon Rekognition. 
In this exercise, you modify the project you previously created and edited (see Use Amazon SageMaker to Provision a Pre-trained Model for a Sample Project) to use the AWS IoT rules engine and an AWS Lambda function.
Topics
 Create and Configure the Lambda Function
 Disable the AWS IoT Rule
Create and Configure the Lambda Function
Create and configure an AWS Lambda function that runs in the Cloud and filters the messages from your AWS DeepLens device for those that have a high enough probability (>0.5) of being a hot dog. You can also change the probability threshold.
Create a Lambda Function

Sign in to the AWS Management Console and open the AWS Lambda console at https://console.aws.amazon.com/lambda/.

Make sure you have selected the US East (N. Virginia) AWS Region.


Choose Create function.


Choose Author from scratch.


Type a name for the Lambda function, for example, _hotdog_notifier.


For Permissions, choose the Create a new Role from AWS policy templates under Execution role.


Type a name for the role; for example, _hotdog_notifier.


For Policy Templates, choose SNS Publish policy and AWS IoT Button permissions.



Choose Create function.


Add an AWS IoT Rule
After the Lambda function is created successfully, you need to set up an AWS IoT rule to trigger the action you specify in your Lambda function (the next step) when an event occurs in the data source. To set up the rule, follow the steps below to add an AWS IoT trigger to the function.


Choose  Add trigger. You may need expand the Design section in the Lambda console, if it's not already expanded.


Choose AWS IoT under Trigger configuration.


For IoT type, choose Custom IoT rule.


For Rule, choose Create a new rule.


For Rule name*, type a name (_search_hotdogs*).


Optionally, give a description for the rule under Rule description.


Under Rule query statement, type into the box an AWS IoT topic query statement of the following format, replacing the red text with the AWS IoT topic for your AWS DeepLens. 


Select Hotdog from '/$aws/deeplens/$aws/things/deeplens_5e6d406g-2bf4-4444-9d4f-4668f7366855/infer'
This query captures messages from your AWS DeepLens in JSON format:
{ "Hotdog" : "0.5438" }
To find the AWS IoT topic for your AWS DeepLens, navigate to **Devices** on your AWS DeepLens, choose your device, then scroll to the bottom of the device detail page\.



Toggle on the Enable trigger option.


Choose Add to finish creating the AWS IoT rule.


Configure the Lambda Function
Configure the Lambda function by replacing the default code with custom code and adding an environmental variable. For this project, you also need to modify the custom code that we provide.


In AWS Lambda, choose Functions, then choose the name of your function.


On the your-name_hotdog_notifier page, choose Configuration.


In the function code box, delete all of the code.


Paste the following JavaScript code in the function code box. You need to change one line in the code to indicate how you want to get notifications. You do that in the next step.


```
   /*
    * This is a sample Lambda function that sends an SMS notification when your
    * AWS DeepLens device detects a hot dog.
    * 
    * Follow these steps to complete the configuration of your function:
    *
    * Update the phone number environment variable with your phone number.
    /
const AWS = require('aws-sdk');
/
   *   Be sure to add email and phone_number to the function's environment variables
   /
   const email = process.env.email;
   const phone_number = process.env.phone_number;
   const SNS = new AWS.SNS({ apiVersion: '2010-03-31' });
exports.handler = (event, context, callback) => {
       console.log('Received event:', event);
   // publish message
   const params = {
       Message: 'Your AWS DeepLens device just identified a hot dog. Congratulations!',
       PhoneNumber: phone_number
   };
   if (event.Hotdog > 0.5) {
       SNS.publish(params, callback);
   }

};
   ```


Add one of the following lines of code in the location indicated in the code block. In the next step, you add an environmental variable that corresponds to the code change you make here.
    To receive email notifications: const email=process.env.email;
    To receive phone notifications: const phone_number=process.env.phone_number;


Choose Environmental variables and add one of the following:  
[See the AWS documentation website for more details]


The key value must match the const name in the line of code that you added in the previous step.

Choose Save and Test (on the upper right).

Test Your Configuration
To test your configuration


Navigate to the AWS IoT console at https://console.aws.amazon.com/iot.


Choose Test.


Publish the following message to the topic that you defined in your rule: { "Hotdog" : "0.6382" }.


You should receive the SMS message that you defined in your Lambda function: Your AWS DeepLens device just identified a hot dog. Congratulations!
Test Using the Hot Dog Project
If you haven't already deployed the Hot Dog project, do the following.


Navigate to https://console.aws.amazon.com/deeplens/home?region=us-east-1#firstrun/ and choose Projects/Create a project template/Hotdog or Not Hotdog.


Deploy the project to your device.


For more information, see Create and Deploy an AWS DeepLens Sample Project in the AWS DeepLens Console.

Show your AWS DeepLens a hot dog to see if it detects it and sends you the confirmation message.

To experiment, change the probability threshold for triggering the Lambda function and see what happens.
Disable the AWS IoT Rule
Unless you want AWS DeepLens to keep notifying you when it sees a hot dog, disable the AWS IoT rule.


Log in to the AWS IoT console at "https://console.aws.amazon.com/iot.


Choose Act*, then choose the rule that you created for this exercise, _search_hotdogs*.


In the upper-right corner, choose Actions, then choose Disable.

