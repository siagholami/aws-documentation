Bootstrapping AWS CloudFormation Windows stacks
This topic describes how to bootstrap a Windows stack and troubleshoot stack creation issues. If you will be creating your own Windows image for use with CloudFormation, see the information at Configuring a Windows instance using EC2ConfigService in the Amazon EC2 Microsoft Windows Guide for instructions. You must set up a Windows instance with EC2ConfigService for it to work with the AWS CloudFormation bootstrapping tools.
Example of bootstrapping a Windows stack
For the purposes of illustration, we'll examine a AWS CloudFormation single-instance Sharepoint server template.
The template can be viewed in its entirety at the following URL:
   https://s3.amazonaws.com/cloudformation-templates-us-east-1/Windows_Single_Server_SharePoint_Foundation.template  
This example demonstrates how to:
 Create an IAM User and Security Group for access to the instance
 Configure initialization files: cfn-credentials, cfn-hup.conf, and cfn-auto-reloader.conf
 Download and install a package such as Sharepoint Foundation 2010 on the server instance.
 Use a WaitCondition to ensure resources are ready 
 Retrieve an IP for the instance with Amazon Elastic IP (EIP).
The AWS CloudFormation helper script cfn-init is used to perform each of these actions, based on information in the AWS::CloudFormation::Init resource in the Windows Single Server Sharepoint Foundation template.
The AWS::CloudFormation::Init section is named "SharePointFoundation", and begins with a standard declaration:
"SharePointFoundation": {
   "Type" : "AWS::EC2::Instance",
   "Metadata" : {
     "AWS::CloudFormation::Init" : {
       "config" : {
After this, the files section of AWS::CloudFormation::Init is declared:
"files" : {
  "c:\\cfn\\cfn-hup.conf" : {
    "content" : { "Fn::Join" : ["", [
      "[main]\n",
      "stack=", { "Ref" : "AWS::StackName" }, "\n",
      "region=", { "Ref" : "AWS::Region" }, "\n"
      ]]}
  },
  "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf" : {
    "content": { "Fn::Join" : ["", [
      "[cfn-auto-reloader-hook]\n",
      "triggers=post.update\n",
      "path=Resources.SharePointFoundation.Metadata.AWS::CloudFormation::Init\n",
      "action=cfn-init.exe -v -s ", { "Ref" : "AWS::StackName" },
                                     " -r SharePointFoundation",
                                     " --region ", { "Ref" : "AWS::Region" }, "\n"
    ]]}
  },
  "C:\\SharePoint\\SharePointFoundation2010.exe" : {
    "source" : "http://d3adzpja92utk0.cloudfront.net/SharePointFoundation.exe"
  }
},
Three files are created here and placed in the C:\cfn directory on the server instance. They are:
 cfn-hup.conf, the configuration file for cfn-hup.
 cfn-auto-reloader.conf, the configuration file for the hook used by cfn-hup to initiate an update (calling cfn-init) when the metadata in AWS::CloudFormation::Init changes.
There is also a file that is downloaded to the server: SharePointFoundation.exe. This file is used to install SharePoint on the server instance.
Important
Since paths on Windows use a backslash ('\') character, you must always remember to properly escape all backslashes by prepending another backslash whenever you refer to a Windows path in the AWS CloudFormation template.
Next is the commands section, which are cmd.exe commands.
"commands" : {
  "1-extract" : {
    "command" : "C:\\SharePoint\\SharePointFoundation2010.exe /extract:C:\\SharePoint\\SPF2010 /quiet /log:C:\\SharePoint\\SharePointFoundation2010-extract.log"
  },
  "2-prereq" : {
    "command" : "C:\\SharePoint\\SPF2010\\PrerequisiteInstaller.exe /unattended"
  },
  "3-install" : {
    "command" : "C:\\SharePoint\\SPF2010\\setup.exe /config C:\\SharePoint\\SPF2010\\Files\\SetupSilent\\config.xml"
  }
Because commands in the instance are processed in alphabetical order by name, each command has been prepended with a number indicating its desired execution order. Thus, we can make sure that the installation package is first extracted, all prerequisites are then installed, and finally, installation of SharePoint is started.
Next is the Properties section:
```
"Properties": {
  "InstanceType" : { "Ref" : "InstanceType" },
  "ImageId" : { "Fn::FindInMap" : [ "AWSRegionArch2AMI", { "Ref" : "AWS::Region" },
                { "Fn::FindInMap" : [ "AWSInstanceType2Arch", { "Ref" : "InstanceType" }, "Arch" ] } ] },
  "SecurityGroups" : [ {"Ref" : "SharePointFoundationSecurityGroup"} ],
  "KeyName" : { "Ref" : "KeyPairName" },
  "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
    "\n",</p>
<pre><code>"cfn-init.exe -v -s ", { "Ref" : "AWS::StackName" },
" -r SharePointFoundation",
" --region ", { "Ref" : "AWS::Region" }, "\n",

"cfn-signal.exe -e %ERRORLEVEL% ", { "Fn::Base64" : { "Ref" : "SharePointFoundationWaitHandle" }}, "\n",

"&lt;/script&gt;"
]]}}
</code></pre>
<p>}
```</p>
<p>In this section, the <code>UserData</code> property contains a <code>cmd.exe</code> script that will be executed by <code>cfn-init</code>, surrounded by <script> tags. You can use a Windows Powershell script here instead by surrounding your script with <powershell> tags. For Windows stacks, you must base64 encode the wait condition handle URL again.</p>
<p>SharePointFoundationWaitHandle is referenced here and run with <code>cfn-signal</code>. The <strong>WaitConditionHandle</strong> and associated <strong>WaitCondition</strong> are declared next in the template:</p>
<p>```
"SharePointFoundationWaitHandle" : {
   "Type" : "AWS::CloudFormation::WaitConditionHandle"
},</p>
<p>"SharePointFoundationWaitCondition" : {
   "Type" : "AWS::CloudFormation::WaitCondition",
   "DependsOn" : "SharePointFoundation",
   "Properties" : {
     "Handle" : {"Ref" : "SharePointFoundationWaitHandle"},
     "Timeout" : "3600"
   }
}
```</p>
<p>Since executing all of the steps and installing SharePoint might take a while, but not an entire hour, the WaitCondition waits an hour (3600 seconds) before timing out.</p>
<p>If all goes well, an Elastic IP is used to provide access to the SharePoint instance:</p>
<p><code>"Outputs" : {
 "SharePointFoundationURL" : {
   "Value" : { "Fn::Join" : ["", ["http://", { "Ref" : "SharePointFoundationEIP" } ]] },
   "Description" : "SharePoint Team Site URL. Please retrieve Administrator password of the instance and use it to access the URL"
 }</code></p>
<p>Once stack creation is complete, the IP address supplied by EIP will be displayed in the <strong>Outputs</strong> tab of the AWS CloudFormation console. However, before you can access the instance you will need to retrieve the auto-generated temporary Administrator password for the instance. For more information, see <a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/connecting_to_windows_instance.html">Connecting to your Windows instance using RDP</a> in the <em>Amazon EC2 User Guide for Windows Instances</em>.</p>
<h2 id="how-to-manage-windows-services">How to manage Windows services<a name="w6640ab1c15c29c15c11"></a></h2>
<p>You manage Windows services in the same way as Linux services, except that you use a <code>windows</code> key instead of <code>sysvinit</code>. The following example starts the <code>cfn-hup</code> service, sets it to Automatic, and restarts the service if cfn-init modifies the <code>c:\cfn\cfn-hup.conf</code> or <code>c:\cfn\hooks.d\cfn-auto-reloader.conf</code> configuration files. </p>
<p><code>"services" : {
  "windows" : {
    "cfn-hup" : {
      "enabled" : "true",
      "ensureRunning" : "true",
      "files" : ["c:\\cfn\\cfn-hup.conf", "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf"]
    }
  }
}</code></p>
<p>You can manage other Windows services in the same way by using the name—not the display name—to reference the service.</p>
<h2 id="how-to-troubleshoot-stack-creation-issues">How to troubleshoot stack creation issues<a name="cfn-windows-stacks-troubleshooting"></a></h2>
<p>If your stack fails during creation, the default behavior is to Rollback on failure. While this is normally a good default because it avoids unnecessary charges, it makes it difficult to debug why your stack creation is failing.</p>
<p>To turn this behavior off, click <strong>Show Advanced Options</strong> when creating your stack with the AWS CloudFormation console, and click the <strong>No</strong> selector next to <strong>Rollback on failure</strong>. This will allow you to log into your instance and view the logfiles to pinpoint issues encountered when running your startup scripts.</p>
<p>Important logs to look at are:
 The EC2 configuration log at <code>C:\Program Files\Amazon\Ec2ConfigService\Logs\Ec2ConfigLog.txt</code>
 The cfn-init log at <code>C:\cfn\log\cfn-init.log</code></p>