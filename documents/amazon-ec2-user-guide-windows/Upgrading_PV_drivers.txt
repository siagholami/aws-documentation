Upgrading PV Drivers on Your Windows Instances
To verify which driver your Windows instance uses, open Network Connections in Control Panel and view the Local Area Connection. Check whether the driver is one of the following:
  AWS PV Network Device 
  Citrix PV Ethernet Adapter 
  RedHat PV NIC Driver 
Alternatively, you can check the output from the pnputil -e command.
Topics
 Upgrade Windows Server Instances (AWS PV Upgrade)
 Upgrade a Domain Controller (AWS PV Upgrade)
 Upgrade Windows Server 2008 and 2008 R2 Instances (Redhat to Citrix PV Upgrade)
 Upgrade Your Citrix Xen Guest Agent Service
Upgrade Windows Server Instances (AWS PV Upgrade)
Use the following procedure to perform an in-place upgrade of AWS PV drivers, or to upgrade from Citrix PV drivers to AWS PV drivers on Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2,Windows Server 2016, or Windows Server 2019. This upgrade is not available for RedHat drivers, or for other versions of Windows Server.
Important
If your instance is a domain controller, see Upgrade a Domain Controller (AWS PV Upgrade). The upgrade process for domain controller instances is different than standard editions of Windows. 
To upgrade AWS PV drivers


Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.


In the navigation pane, choose Instances.


Choose the instance that requires the driver upgrade, open the context (right-click) menu, choose Instance State, and then choose Stop.
Warning
When you stop an instance, the data on any instance store volumes is erased. To keep data from instance store volumes, be sure to back it up to persistent storage.


After the instance is stopped, create a backup. Open the context (right-click) menu for the instance, choose Image, and then choose Create Image.


From the context (right-click) menu for the instance, choose Instance State, and then choose Start.


Connect to the instance using Remote Desktop and prepare the instance for upgrade. We recommend that you take all non-system disks offline and note any drive letter mappings to the secondary disks in Disk Management before you perform this upgrade. Note that this step is not required if you are performing an in-place update of AWS PV drivers. We also recommend setting non-essential services to Manual start-up in the Services console.


Download the latest driver package to the instance.
Or, run the following PowerShell command:


PS C:\>invoke-webrequest https://s3.amazonaws.com/ec2-windows-drivers-downloads/AWSPV/Latest/AWSPVDriver.zip -outfile $env:USERPROFILE\pv_driver.zip
   expand-archive $env:userprofile\pv_driver.zip -DestinationPath $env:userprofile\pv_drivers

Extract the contents of the folder and then run AWSPVDriverSetup.msi.

After running the MSI, the instance automatically reboots and then upgrades the driver. The instance will not be available for up to 15 minutes. After the upgrade is complete and the instance passes both health checks in the Amazon EC2 console, you can verify that the new driver was installed by connecting to the instance using Remote Desktop and then running the following PowerShell command:
Get-ItemProperty HKLM:\SOFTWARE\Amazon\PVDriver
Verify that the driver version is the same as the latest version listed in the Driver Version History table. For more information, see AWS PV Driver Package History Open Disk Management to review any offline secondary volumes and bring them online corresponding to the drive letters noted in Step 6.
If you previously disabled TCP Offloading using Netsh for Citrix PV drivers we recommend that you re-enable this feature after upgrading to AWS PV drivers. TCP Offloading issues with Citrix drivers are not present in the AWS PV drivers. As a result, TCP Offloading provides better performance with AWS PV drivers.
If you previously applied a static IP address or DNS configuration to the network interface, you must reapply the static IP address or DNS configuration after upgrading AWS PV drivers.
Upgrade a Domain Controller (AWS PV Upgrade)
Use the following procedure on a domain controller to perform either an in-place upgrade of AWS PV drivers, or to upgrade from Citrix PV drivers to AWS PV drivers.
To upgrade a domain controller


Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.


In the navigation pane, choose Instances.


Choose the instance that requires the driver upgrade, open the context (right-click) menu, choose Instance State, and then choose Stop.
Warning
When you stop an instance, the data on any instance store volumes is erased. To keep data from instance store volumes, be sure to back it up to persistent storage.


After the instance is stopped, create a backup. Open the context (right-click) menu for the instance, choose Image, and then choose Create Image.


From the context (right-click) menu for the instance, choose Instance State, and then choose Start.


Run the following command to configure Windows to boot into Directory Services Restore Mode (DSRM):


bcdedit /set {default} safeboot dsrepair
PowerShell:
PS C:\> bcdedit /set "{default}" safeboot dsrepair
Warning
Before running this command, confirm that you know the DSRM password. You'll need this information so that you can log in to your instance after the upgrade is complete and the instance automatically reboots.
The system must boot into DSRM because the upgrade utility removes Citrix PV storage drivers so it can install AWS PV drivers. Therefore we recommend noting any drive letter and folder mappings to the secondary disks in Disk Management. When Citrix PV storage drivers are not present, secondary drives will not be detected. Domain controllers that use an NTDS folder on secondary drives will not boot because the secondary disk will not be detected.
Warning
After you run this command do not manually reboot the system. The system will be unreachable because Citrix PV drivers do not support DSRM.

Run the following command to add DisableDCCheck to the registry:

reg add HKLM\SOFTWARE\Wow6432Node\Amazon\AWSPVDriverSetup /v DisableDCCheck /t REG_SZ /d true


Download the latest driver package to the instance.


Extract the contents of the folder and then run AWSPVDriverSetup.msi.


After running the MSI, the instance automatically reboots and then upgrades the driver. The instance will not be available for up to 15 minutes. 


After the upgrade is complete and the instance passes both health checks in the Amazon EC2 console, connect to the instance using Remote Desktop. Open Disk Management to review any offline secondary volumes and bring them online corresponding to the drive letters and folder mappings noted in Step 6. 
Important
You must connect to the instance by specifying the user name in the following format hostname\administrator. For example, Win2k12TestBox\administrator.


Run the following command to remove the DSRM boot configuration:


bcdedit /deletevalue safeboot


Reboot the instance.


To complete the upgrade process, verify that the new driver was installed. In Device Manager, under Storage Controllers, locate AWS PV Storage Host Adapter. Verify that the driver version is the same as the latest version listed in the Driver Version History table. For more information, see AWS PV Driver Package History.


Run the following command to delete DisableDCCheck from the registry:


reg delete HKLM\SOFTWARE\Wow6432Node\Amazon\AWSPVDriverSetup /v DisableDCCheck
Note
If you previously disabled TCP Offloading using Netsh for Citrix PV drivers we recommend that you re-enable this feature after upgrading to AWS PV Drivers. TCP Offloading issues with Citrix drivers are not present in the AWS PV drivers. As a result, TCP Offloading provides better performance with AWS PV drivers.
Upgrade Windows Server 2008 and 2008 R2 Instances (Redhat to Citrix PV Upgrade)
Before you start upgrading your RedHat drivers to Citrix PV drivers, make sure you do the following:
 Install the latest version of the EC2Config service. For more information, see Installing the Latest Version of EC2Config.
 Verify that you have Windows PowerShell 2.0 installed. To verify the version that you have installed, run the following command in a PowerShell window:
PS C:\> $PSVersionTable.PSVersion
If you need to install version 2.0, see Windows Management Framework Core Package (Windows PowerShell 2.0 and WinRM) from Microsoft Support.
 Back up your important information on the instance, or create an AMI from the instance. For more information about creating an AMI, see Create a custom Windows AMI. If you create an AMI, make sure that you do the following:
   Write down your password.
   Do not run the Sysprep tool manually or using the EC2Config service.
   Set your Ethernet adapter to obtain an IP address automatically using DHCP. For more information, see Configure TCP/IP Settings in the Microsoft TechNet Library.
To upgrade Redhat drivers


Connect to your instance and log in as the local administrator. For more information about connecting to your instance, see Connecting to your Windows instance.


In your instance, download the Citrix PV upgrade package.


Extract the contents of the upgrade package to a location of your choice.


Double-click the Upgrade.bat file. If you get a security warning, choose Run.


In the Upgrade Drivers dialog box, review the information and choose Yes if you are ready to start the upgrade.


In the Red Hat Paravirtualized Xen Drivers for Windows uninstaller dialog box, choose Yes to remove the RedHat software. Your instance will be rebooted.
Note
If you do not see the uninstaller dialog box, choose Red Hat Paravirtualize in the Windows taskbar.



Check that the instance has rebooted and is ready to be used.


Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.


On the Instances page, right-click your instance and select Get System Log.


The upgrade operations should have restarted the server 3 or 4 times. You can see this in the log file by the number of times Windows is Ready to use is displayed.



Connect to your instance and log in as the local administrator.


Close the Red Hat Paravirtualized Xen Drivers for Windows uninstaller dialog box.


Confirm that the installation is complete. Navigate to the Citrix-WIN_PV folder that you extracted earlier, open the PVUpgrade.log file, and then check for the text INSTALLATION IS COMPLETE.



Upgrade Your Citrix Xen Guest Agent Service
If you are using Citrix PV drivers on Windows Server, you can upgrade the Citrix Xen guest agent service. This Windows service handles tasks such as shutdown and restart events from the API. You can run this upgrade package on any version of Windows Server, as long as the instance is running Citrix PV drivers.
Important
For Windows Server 2008 R2 and later, we recommend you upgrade to AWS PV drivers that include the Guest Agent update.
Before you start upgrading your drivers, make sure you back up your important information on the instance, or create an AMI from the instance. For more information about creating an AMI, see Create a custom Windows AMI. If you create an AMI, make sure you do the following:
 Do not enable the Sysprep tool in the EC2Config service.
 Write down your password.
 Set your Ethernet adapter to DHCP. 
To upgrade your Citrix Xen guest agent service


Connect to your instance and log in as the local administrator. For more information about connecting to your instance, see Connecting to your Windows instance.


On your instance, download the Citrix upgrade package.


Extract the contents of the upgrade package to a location of your choice.


Double-click the Upgrade.bat file. If you get a security warning, choose Run.


In the Upgrade Drivers dialog box, review the information and choose Yes if you are ready to start the upgrade. 


When the upgrade is complete, the PVUpgrade.log file will open and contain the text UPGRADE IS COMPLETE.


Reboot your instance. 

