Monitoring Your Tape Gateway
In this section, you can find information about how to monitor your tape gateway, virtual tapes associated with your tape gateway, cache storage, and the upload buffer. You use the AWS Management Console to view metrics for your tape gateway. With metrics, you can track the health of your tape gateway and set up alarms to notify you when one or more metrics are outside a defined threshold. 
Storage Gateway provides CloudWatch metrics at no additional charge. Storage Gateway metrics are recorded for a period of two weeks. By using these metrics, you can access historical information and get a better perspective of how your tape gateway and virtual tapes are performing. For detailed information about CloudWatch, see the Amazon CloudWatch User Guide.
Topics
 Getting Tape Gateway Health Logs with CloudWatch Log Groups
 Using Amazon CloudWatch Metrics
 Understanding Virtual Tape Metrics
 Measuring Performance Between Your Tape Gateway and AWS
Getting Tape Gateway Health Logs with CloudWatch Log Groups
You can use Amazon CloudWatch Logs to get information about the health of your tape gateway and related resources. You can use the logs to monitor your gateway for errors that it encounters. In addition, you can use Amazon CloudWatch subscription filters to automate processing of the log information in real time. For more information, see Real-time Processing of Log Data with Subscriptions in the Amazon CloudWatch User Guide.
For example, suppose that your gateway is deployed in a cluster enabled with VMware HA and you need to know about any errors. You can configure a CloudWatch log group to monitor your gateway and get notified when your gateway encounters an error. You can either configure the group when you are activating the gateway or after your gateway is activated and up and running. For information about how to configure a CloudWatch log group when activating a gateway, see Configuring Amazon CloudWatch Logging. For general information about CloudWatch log groups, see Working with Log Groups and Log Streams in the Amazon CloudWatch User Guide.
For information about how to troubleshoot and fix these types of errors, see Troubleshooting virtual tape issues.
The following procedure shows you how to configure a CloudWatch log group after your gateway is activated. 
To configure a CloudWatch log group to work with your tape gateway


Sign in to the AWS Management Console and open the AWS Storage Gateway console at https://console.aws.amazon.com/storagegateway/home.


Choose Gateways and choose the gateway that you want to configure the CloudWatch log group for. 


For Actions, choose Edit gateway Information.


For Gateway Log Group, choose the log group that you want to use. If you don't have a log group, choose the Create new Log Group link to create one. You are directed to the CloudWatch Logs console where you can create the log group. If you create a new log group, choose the refresh button to view the new log group in the list.


When you are done, choose Save.


Following is an example of a tape gateway event message that is sent to CloudWatch. This example shows a TapeStatusTransition message.
{
    "severity": "INFO",
    "source": "FZTT16FCF5",
    "type": "TapeStatusTransition",
    "gateway": "sgw-C51DFEAC",
    "timestamp": "1581553463831",
    "newStatus": "RETRIEVED"
    }
To see the logs for your gateway, choose the gateway and choose the Details tab.
Using Amazon CloudWatch Metrics
You can get monitoring data for your tape gateway by using either the AWS Management Console or the CloudWatch API. The console displays a series of graphs based on the raw data from the CloudWatch API. The CloudWatch API can also be used through one of the Amazon AWS Software Development Kits (SDKs) or the Amazon CloudWatch API tools. Depending on your needs, you might prefer to use either the graphs displayed in the console or retrieved from the API.
Regardless of which method you choose to use to work with metrics, you must specify the following information: 
 The metric dimension to work with. A dimension is a name-value pair that helps you to uniquely identify a metric. The dimensions for Storage Gateway are GatewayId and GatewayName. In the CloudWatch console, you can use the Gateway Metrics view to easily select gateway-specific and tape-specific dimensions. For more information about dimensions, see Dimensions in the Amazon CloudWatch User Guide.
 The metric name, such as ReadBytes.
The following table summarizes the types of Storage Gateway metric data that are available to you. 



Amazon CloudWatch Namespace
Dimension
Description




AWS/StorageGateway
GatewayId, GatewayName
These dimensions filter for metric data that describes aspects of the tape gateway. You can identify a tape gateway to work with by specifying both the GatewayId and the GatewayName dimensions.  Throughput and latency data of a tape gateway is based on all the virtual tapes in the tape gateway. Data is available automatically in 5-minute periods at no charge.



Working with gateway and tape metrics is similar to working with other service metrics. You can find a discussion of some of the most common metrics tasks in the CloudWatch documentation listed following:
 Viewing Available Metrics
 Getting Statistics for a Metric
 Creating CloudWatch Alarms
Understanding Virtual Tape Metrics
You can find information following about the Storage Gateway metrics that cover virtual tapes. Each tape has a set of metrics associated with it. 
Some tape-specific metrics might have the same name as certain gateway-specific metrics. These metrics represent the same kinds of measurements but are scoped to a tape instead of a gateway. Before starting work, specify whether you want to work with a gateway metric or a tape metric. When working with tape metrics, specify the tape ID for the tape that you want to view metrics for. For more information, see Using Amazon CloudWatch Metrics.
The following table describes the Storage Gateway metrics that you can use to get information about your tapes. 



Metric
Description




CachePercentDirty
The tape's contribution to the overall percentage of the gateway's cache that isn't persisted to AWS. The sample is taken at the end of the reporting period. Use the CachePercentDirty metric of the gateway to view the overall percentage of the gateway's cache that isn't persisted to AWS. For more information, see Understanding gateway metrics. Units: Percent


ClientTraffic
The amount of bytes the tape sent and received from on-premises clients. That is, the total amount of ReadBytes and WriteBytes from client applications. Units: bytes


CloudTraffic
The amount of bytes uploaded and downloaded from the cloud to the tape. Units: bytes


CpuUsage
The percentage of allocated CPU compute units that are currently used by the tape.  Units: Percent


HealthNotificationCount
The number of health notifications sent by the tape. Units: count


MemoryUsage
The percentage of allocated memory that is currently used by the tape.  Units: Percent



Measuring Performance Between Your Tape Gateway and AWS
Data throughput, data latency, and operations per second are measures that you can use to understand how your application storage that is using your tape gateway is performing. When you use the correct aggregation statistic, these values can be measured by using the Storage Gateway metrics that are provided for you. 
A statistic is an aggregation of a metric over a specified period of time. When you view the values of a metric in CloudWatch, use the Average statistic for data latency (milliseconds), and use the Samples statistic for input/output operations per second (IOPS). For more information, see Statistics in the Amazon CloudWatch User Guide.
The following table summarizes the metrics and the corresponding statistic you can use to measure the throughput, latency, and IOPS between your tape gateway and AWS. 



Item of Interest
How to Measure




Latency
Use the ReadTime and WriteTime metrics with the Average CloudWatch statistic. For example, the Average value of the ReadTime metric gives you the latency per operation over the sample period of time.


Throughput to AWS
Use the CloudBytesDownloaded and CloudBytesUploaded metrics with the Sum CloudWatch statistic. For example, the Sum value of the CloudBytesDownloaded metric over a sample period of 5 minutes divided by 300 seconds gives you the throughput from AWS to the tape gateway as a rate in bytes per second.


Latency of data to AWS
Use the CloudDownloadLatency metric with the Average statistic. For example, the Average statistic of the CloudDownloadLatency metric gives you the latency per operation.



To measure the upload data throughput from a tape gateway to AWS


Open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.


Choose the Metrics tab.


Choose the StorageGateway: Gateway Metrics dimension, and find the tape gateway that you want to work with.


Choose the CloudBytesUploaded metric.


For Time Range, choose a value.


Choose the Sum statistic.


For Period, choose a value of 5 minutes or greater.


In the resulting time-ordered set of data points, divide each data point by the period (in seconds) to get the throughput at that sample period.


The following image shows the CloudBytesUploaded metric for a gateway tape with the Sum statistic. In the image, placing the cursor over a data point displays information about the data point, including its value and the number of bytes uploaded. Divide this value by the Period value (5 minutes) to get the throughput at that sample point. For the point highlighted, the throughput from the tape gateway to AWS is 555,544,576 bytes divided by 300 seconds, which is 1.7 megabytes per second.

To measure the data latency from a tape gateway to AWS


Open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.


Choose the Metrics tab.


Choose the StorageGateway: GatewayMetrics dimension, and find the tape gateway that you want to work with.


Choose the CloudDownloadLatency metric.


For Time Range, choose a value.


Choose the Average statistic.


For Period, choose a value of 5 minutes to match the default reporting time. 


The resulting time-ordered set of data points contains the latency in milliseconds.
To set an upper threshold alarm for a tape gateway's throughput to AWS


Open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.


Choose Create Alarm to start the Create Alarm wizard.


Choose the StorageGateway: Gateway Metrics dimension, and find the tape gateway that you want to work with.


Choose the CloudBytesUploaded metric.


Define the alarm by defining the alarm state when the CloudBytesUploaded metric is greater than or equal to a specified value for a specified time. For example, you can define an alarm state when the CloudBytesUploaded metric is greater than 10 megabytes for 60 minutes.


Configure the actions to take for the alarm state. For example, you can have an email notification sent to you. 


Choose Create Alarm.


To set an upper threshold alarm for reading data from AWS


Open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.


Choose Create Alarm to start the Create Alarm wizard.


Choose the StorageGateway: Gateway Metrics dimension, and find the tape gateway that you want to work with.


Choose the CloudDownloadLatency metric.


Define the alarm by defining the alarm state when the CloudDownloadLatency metric is greater than or equal to a specified value for a specified time. For example, you can define an alarm state when the CloudDownloadLatency is greater than 60,000 milliseconds for greater than 2 hours.


Configure the actions to take for the alarm state. For example, you can have an email notification sent to you.


Choose Create Alarm.

