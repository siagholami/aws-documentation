Using the PKCS7 signature to verify the instance identity document
This topic explains how to verify the instance identity document using the PKCS7 signature and the AWS DSA public certificate.
To verify the instance identity document using the PKCS7 signature and the AWS DSA public certificate


Connect to the instance.


Retrieve the PKCS7 signature from the instance metadata and add it to a file named pkcs7.


Add the -----BEGIN PKCS7----- header to the pkcs7 file.
$ echo "-----BEGIN PKCS7-----" > pkcs7


Retrieve the PKCS7 signature from the instance metadata and append it to the pkcs7 file. Use one of the following commands depending on the IMDS version used by the instance.



[ IMDSv2 ]
  ```
  $ TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \ 
  && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/dynamic/instance-identity/pkcs7 >> pkcs7
  ```


[ IMDSv1 ]
  ```
  $ curl -s http://169.254.169.254/latest/dynamic/instance-identity/pkcs7 >> pkcs7
  ```




Append the -----END PKCS7----- footer to a new line in the pkcs7 file.
$ echo "" >> pkcs7
  $ echo "-----END PKCS7-----" >> pkcs7


Add the contents of the instance identity document from the instance metadata to a file named document. Use one of the following commands depending on the IMDS version used by the instance.



[ IMDSv2 ]
$ TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \ && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/dynamic/instance-identity/document > document

[ IMDSv1 ]
$ curl -s http://169.254.169.254/latest/dynamic/instance-identity/document > document



Add the AWS DSA public certificate to a file named certificate.


Create the certificate file.
$ touch certificate


Open the certificate file using your preferred text editor and add the contents of the AWS DSA public certificate. Choose the correct certificate for the AWS Region that your instance is in.
Important
If the AWS DSA public certificate for your Region is not listed below, contact AWS Support.



[ Other AWS Regions ]
  The following AWS public certificate is for all AWS Regions, except Hong Kong, Bahrain, China, and GovCloud\.

  ```
  -----BEGIN CERTIFICATE-----
  MIIC7TCCAq0CCQCWukjZ5V4aZzAJBgcqhkjOOAQDMFwxCzAJBgNVBAYTAlVTMRkw
  FwYDVQQIExBXYXNoaW5ndG9uIFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYD
  VQQKExdBbWF6b24gV2ViIFNlcnZpY2VzIExMQzAeFw0xMjAxMDUxMjU2MTJaFw0z
  ODAxMDUxMjU2MTJaMFwxCzAJBgNVBAYTAlVTMRkwFwYDVQQIExBXYXNoaW5ndG9u
  IFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYDVQQKExdBbWF6b24gV2ViIFNl
  cnZpY2VzIExMQzCCAbcwggEsBgcqhkjOOAQBMIIBHwKBgQCjkvcS2bb1VQ4yt/5e
  ih5OO6kK/n1Lzllr7D8ZwtQP8fOEpp5E2ngD6Ud1Z1gYipr58Kj3nssSNpI6bX3
  VyIQzK7wLclnd/YozqNNmgIyZecN7EglK9ITHJLPx8FtUpt3QbyYXJdmVMegN6P
  hviYt5JH/nYl4hh3Pa1HJdskgQIVALVJ3ER11Ko4tP6nwvHwh6ERYRAoGBAI1j
  ktkqMVHuAFcvAGKocTgsjJem6/5qomzJuKDmbJNu9Qxw3rAotXau8QeMBcJl/U
  hhy1KHVpCGl9fueQ2s6IL0CaO/buycU1CiYQk40KNHCcHfNiZbdlx1E9rpUp7bnF
  lRa2v1ntMX3caRVDdbtPEWmdxSCYsYFDk4mZrOLBA4GEAAKBgEbmeve5f8LIE/Gf
  MNmP9CM5eovQOGx5ho8WqDaTebsk2tn92BBPqeZqpWRa5P/jrdKml1qx4llHW
  MXrs3IgIb6hUIBS8dz8/mmO0bpr76RoZVCXYab2CZedFut7qc3WUH9EUAH5mw
  vSeDCOUMYQR7R9LINYwouHIziqQYMAkGByqGSM44BAMDLwAwLAIUWXBlk40xTwSw
  7HX32MxXYruse9ACFBNGmdX2ZBrVNGrN9N2f6ROk0k9K
  -----END CERTIFICATE-----
  ```


[ Hong Kong Region ]
  The AWS public certificate for the Hong Kong Region is as follows\.

  ```
  -----BEGIN CERTIFICATE-----
  MIIC7zCCAq4CCQCO7MJe5Y3VLjAJBgcqhkjOOAQDMFwxCzAJBgNVBAYTAlVTMRkw
  FwYDVQQIExBXYXNoaW5ndG9uIFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYD
  VQQKExdBbWF6b24gV2ViIFNlcnZpY2VzIExMQzAeFw0xOTAyMDMwMjIxMjFaFw00
  NTAyMDMwMjIxMjFaMFwxCzAJBgNVBAYTAlVTMRkwFwYDVQQIExBXYXNoaW5ndG9u
  IFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYDVQQKExdBbWF6b24gV2ViIFNl
  cnZpY2VzIExMQzCCAbgwggEsBgcqhkjOOAQBMIIBHwKBgQDvQ9RzVvf4MAwGbqfX
  blCvCoVb9957OkLGn/04CowHXJvTBR7eyIa6AoXltsQXBOmrJswToFKKxT4gbuw
  jK7s9QQX4CmTRWcEgO2RXtZSVjOhsUQMhyf7Ht4OVL97LWnNfGsX2cwjcRWHYgI
  7lvnuBNBzLQHdSEwMNq0Bk76PwIVAMan6XIEEPnwr4e6u/RNnWBGKd9FAoGBAOCG
  eSNmxpW4QFu4pIlAykm6EnTZKKHT87gdXkAkfoC5fAfOxxhnE2HezZHp9Ap2tMV5
  8bWNvoPHvoKCQqwfmOUBlAxC/3vqoVkKL2mG1KgUH9hrtpMTkwO3RREnKe7I5O
  x9qDimJpOihrL4I0dYvy9xUOozDzFAW8ylWVYpA4GFAAKBgQDbnBAKSxWr9QHY
  6DtEFdGz6lAZLedeBKpaP53Z1DTO34J0C55YbJTwBTFGqPtOLxnUVDlGiD6GbmC
  80f3jvogPR1mSmGsydbNbZnbUEVWrRhey5zJ3g9qs/DWmDW0deEFvkhWVnLJkFJ
  9pdOu/ibRPH1lE2nz6pK7GbOQtLyHTAJBgcqhkjOOAQDAzAAMC0CFQCoJlwGtJQC
  cLoM4p/jtVFOj26xbgIUUS4pDKyHaG/eaygLTtFpFJqzWHc=
  -----END CERTIFICATE-----
  ```


[ Bahrain Region ]
  The AWS public certificate for the Bahrain Region is as follows\.

  ```
  -----BEGIN CERTIFICATE-----
  MIIC7jCCAq4CCQCVWIgSmP8RhTAJBgcqhkjOOAQDMFwxCzAJBgNVBAYTAlVTMRkw
  FwYDVQQIExBXYXNoaW5ndG9uIFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYD
  VQQKExdBbWF6b24gV2ViIFNlcnZpY2VzIExMQzAeFw0xOTAyMDUxMzA2MjFaFw00
  NTAyMDUxMzA2MjFaMFwxCzAJBgNVBAYTAlVTMRkwFwYDVQQIExBXYXNoaW5ndG9u
  IFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYDVQQKExdBbWF6b24gV2ViIFNl
  cnZpY2VzIExMQzCCAbgwggEsBgcqhkjOOAQBMIIBHwKBgQDcwojQfgWdV1QliO0B
  8n6cLZ38VE7ZmrjZ9OQV//Gst6S1h7euhC23YppKXi1zovefSDwFU54zi3/oJq
  PHlP1WGL8IZ34BUgRTtG4TVolvp0smjkMvyRu5hIdKtzjV93Ccx15gVgyko1IEG
  fZ2Kbw/Dd8JfoPS7KaSCmJKxXQIVAIZbIaDFRGa2qcMkW2HWASyNDl7bAoGBANtz
  IdhfMql2I5iofY2oj3HI21Kj3LtZrWEg3W/4rVhL3lTm0Nne1rl9yGujrjQwy5
  Zp9V4A/w9w2O10Lx4K6hj34Eefy/aQnZwNdNhv/FQP7Az0fjuYl6L13OOHQrL0z
  Q9cF7zEosekEnBQx3v6psNknKgD3ShgxGO/LpCA4GFAAKBgQCVS7m77nuNAlZ8
  wvUqcooxXMPkxJFl54NxAsAul9KP9KN4svm0O3Zrb7t2FOtXRM8zU3TqMpryq1o5
  mpMPsZDg6RXo9BF7Hn0DoZ6PJTamkFA6mdNyTJWJKvXC7iJ8fGDBJqTciUHuCKr
  12AztQ8bFWsrTgTzPE3p6U5ckcgV1TAJBgcqhkjOOAQDAy8AMCwCFB2NZGWm5EDl
  86ayV3c1PEDukgQIAhQow38rQkN/VwHVeSW9DqEshXHjuQ==
  -----END CERTIFICATE-----
  ```


[ GovCloud Regions ]
  The AWS public certificate for the AWS GovCloud Regions is as follows\.

  ```
  -----BEGIN CERTIFICATE-----
  MIIC7TCCAq0CCQCWukjZ5V4aZzAJBgcqhkjOOAQDMFwxCzAJBgNVBAYTAlVTMRkw
  FwYDVQQIExBXYXNoaW5ndG9uIFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYD
  VQQKExdBbWF6b24gV2ViIFNlcnZpY2VzIExMQzAeFw0xMjAxMDUxMjU2MTJaFw0z
  ODAxMDUxMjU2MTJaMFwxCzAJBgNVBAYTAlVTMRkwFwYDVQQIExBXYXNoaW5ndG9u
  IFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYDVQQKExdBbWF6b24gV2ViIFNl
  cnZpY2VzIExMQzCCAbcwggEsBgcqhkjOOAQBMIIBHwKBgQCjkvcS2bb1VQ4yt/5e
  ih5OO6kK/n1Lzllr7D8ZwtQP8fOEpp5E2ngD6Ud1Z1gYipr58Kj3nssSNpI6bX3
  VyIQzK7wLclnd/YozqNNmgIyZecN7EglK9ITHJLPx8FtUpt3QbyYXJdmVMegN6P
  hviYt5JH/nYl4hh3Pa1HJdskgQIVALVJ3ER11Ko4tP6nwvHwh6ERYRAoGBAI1j
  ktkqMVHuAFcvAGKocTgsjJem6/5qomzJuKDmbJNu9Qxw3rAotXau8QeMBcJl/U
  hhy1KHVpCGl9fueQ2s6IL0CaO/buycU1CiYQk40KNHCcHfNiZbdlx1E9rpUp7bnF
  lRa2v1ntMX3caRVDdbtPEWmdxSCYsYFDk4mZrOLBA4GEAAKBgEbmeve5f8LIE/Gf
  MNmP9CM5eovQOGx5ho8WqDaTebsk2tn92BBPqeZqpWRa5P/jrdKml1qx4llHW
  MXrs3IgIb6hUIBS8dz8/mmO0bpr76RoZVCXYab2CZedFut7qc3WUH9EUAH5mw
  vSeDCOUMYQR7R9LINYwouHIziqQYMAkGByqGSM44BAMDLwAwLAIUWXBlk40xTwSw
  7HX32MxXYruse9ACFBNGmdX2ZBrVNGrN9N2f6ROk0k9K
  -----END CERTIFICATE-----
  ```


[ China Regions ]
  The AWS public certificate for the China \(Beijing\) and China \(Ningxia\) Regions is as follows\.

  ```
  -----BEGIN CERTIFICATE-----
  MIIDNjCCAh4CCQD3yZ1w1AVkTzANBgkqhkiG9w0BAQsFADBcMQswCQYDVQQGEwJV
  UzEZMBcGA1UECBMQV2FzaGluZ3RvbiBTdGF0ZTEQMA4GA1UEBxMHU2VhdHRsZTEg
  MB4GA1UEChMXQW1hem9uIFdlYiBTZXJ2aWNlcyBMTEMwIBcNMTUwNTEzMDk1OTE1
  WhgPMjE5NDEwMTYwOTU5MTVaMFwxCzAJBgNVBAYTAlVTMRkwFwYDVQQIExBXYXNo
  aW5ndG9uIFN0YXRlMRAwDgYDVQQHEwdTZWF0dGxlMSAwHgYDVQQKExdBbWF6b24g
  V2ViIFNlcnZpY2VzIExMQzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
  AMWk9vyppSmDU3AxZ2Cy2bvKeK3F1UqNpMuyeriiziNTsZ8tQqtNloaQcqhto/l
  gsw9QSnEJeYWnmivJWOBdn9CyDpN7cpHVmeGgNJL2fvImWyWe2f2Kq/BL9l7N7C
  P2ZT52/sH9orlck1n2zO8xPi7MItgPHQwu3OxsGQsAdWucdxjHGtdchulpo1uJ31
  jsTAPKZ3p1/sxPXBBAgBMatPHhRBqhwHO/Twm4J3GmTLWN7oVDds4W3bPKQfnw3r
  vtBj/SM4/IgQ3xJslFcl90TZbQbgxIi88R/gWTbs7GsyT2PzstU30yLdJhKfdZKz
  /aIzraHvoDTWFaOdy0OOaECAwEAATANBgkqhkiG9w0BAQsFAAOCAQEAdSzN20E
  V1BfR3DPWJHWRf1b7zl1X/ZseW2hYE5r6YxrLv1VPf/L5I6kB7GEtqhZUqteY7
  zAceoLrVu/7OynRyfQetJVGichaaxLNM3lcr6kcxOowbWQQ84cwrB3keykH4gRX
  KHB2rlWSxta2panSEO1JX2q5jhcFP90rDOtZjlpYv57N/Z9iQdvQPJnChdq3BK
  5pZlnIDnVVxqRike7BFy8tKyPj7HzoPEF5mh9Kfnn1YoSVu61lMVv/qRjnyKfS9
  c96nE98sYFj0ZVBzXw8Sq4Gh8FiVmFHbQp1peGC19idOUqxPxWsasWxQXO0azYsP
  9RyWLHKxH1dMuA==
  -----END CERTIFICATE-----
  ```




Save and close the file.


Use the OpenSSL smime command to verify the signature. Include the -verify option to indicate that the signature needs to be verified, and the -noverify option to indicate that the certificate does not need to be verified.


$ openssl smime -verify -in pkcs7 -inform PEM -content document -certfile certificate -noverify
If the signature is valid, the Verification successful message appears. If the signature cannot be verified, contact AWS Support.